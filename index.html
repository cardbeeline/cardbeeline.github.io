<!doctype html>
<html>
	<head>
		<meta http-equiv="Cache-Control" content="no-cache" />
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.25, maximum-scale=5, user-scalable=yes" />		
		<title>Акции карты "Билайн"</title>

		<!-- Stylesheets 
		<link href="css/global.css" rel="stylesheet"></link>
		<link href="style.css" rel="stylesheet"></link>
		<link href="css/chewing-grid.css" rel="stylesheet">
		<link href="css/chewing-grid-atomic.min.css" rel="stylesheet">
		<link href="//fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
		-->
		<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
		<link href="//storage.googleapis.com/code.getmdl.io/1.0.6/material.indigo-pink.min.css" rel="stylesheet">
		<link href="fonts.css" rel="stylesheet">
		<link href="css/forms.css" rel="stylesheet">
		<link href="css/texts.css" rel="stylesheet">
		<link href="css/actions.css" rel="stylesheet">

		<!-- Scripts -->
		<script src="js/jquery-2.1.3.min.js"></script>
		<script src="js/parse-1.6.14.min.js"></script>
		<script src="js/handlebars-v4.0.5.js"></script>
		<script src="//storage.googleapis.com/code.getmdl.io/1.0.6/material.min.js"></script>



	</head>

	<body>
		<!-- Google Tag Manager -->
		<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-T29DH2"
		height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
		<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
		new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
		j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
		'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
		})(window,document,'script','dataLayer','GTM-T29DH2');</script>
		<!-- End Google Tag Manager -->


		<div class="content clearfix" id = "partners" >

			<script type="text/x-handlebars-template" id='table-data'>
				<ul class="content-grid mdl-grid panels">
					{{#items}}
					<li class="mdl-cell content-wrap mdl-shadow--2dp">
						<div class="fix-wrap">
							<div class="chew-card ">
								<div class="content-block common" style="border-width:0">
									<div class="media">
										<img src="{{#if parentId}}{{parentId.imageFile.url}}{{else}}{{imageFile.url}}{{/if}}" alt="">
										<h3> {{title}}</h3>
									</div>
									<!--div class="mdl-card__menu cardmenu">
												<button class="sharebutton mdl-button mdl-button--icon mdl-js-button mdl-js-ripple-effect">	<i class="fa fa-share-alt"></i>	</button>
												{{> sharemenu .. }}
									</div-->

									<p><strong>{{#if parentId}}{{parentId.subtitle}}{{else}}{{subtitle}}{{/if}}</strong></p>
									{{{contentText}}}
									<p>{{{contactInfo}}}</p>
								
								</div>
								<div class="beecard_panel_button">
									<a class="btn-link" href="{{urlParams targetURL}}" target="_blank" id="click-{{#if sourceId}}{{sourceId}}{{else}}{{contentId}}{{/if}}"> <i class="fa fa-shopping-cart"></i>
									&nbsp; {{#if targetName}}{{targetName}}{{else}}Начать покупки{{/if}}</a>
								</div> 

							</div>
						</div>
					</li>	
					{{/items}}              
					<li class="chew-cell chew-cell--ghost"></li>
					<li class="chew-cell chew-cell--ghost"></li>
				</ul>
			</script>

		</div>

		<script type="text/JavaScript" >

			var vars = {};
			var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {
					vars[key.toLowerCase()] = value;
				});

			var session = vars["session"];
			var EAN = vars["ean"];
			var city = vars["city"];
			var name = vars["name"];

			Parse.initialize("27OaUv04EXFliQUSh0Nv6K49YIITL1m7g79CBEum", "nlfPaLHJejOkEY9ATKrpkuhogwJgNYs4anMJ9bLC");
			if (typeof session !== "undefined") {
				Parse.User.become(session);
			}
			var Content = Parse.Object.extend("Content");
			var query = new Parse.Query(Content);
			query.containedIn("contentClass", ["PARTNER", "ADMITAD"]);
			query.equalTo("visible", 	true);
			query.greaterThanOrEqualTo("actualTo", new Date());
			query.descending("sortIndex,createdAt");
			var tableTemplate = $("#table-data").html();

			query.find({
				success : function (results) {
					var items = [];

					for (var i = 0; i < results.length; i++) {
					    if (EAN || (results[i].get("targetURL").indexOf(".admitad.") == -1 && results[i].get("targetURL").indexOf(".com/g/") == -1)) {
                            if (results[i].get("contentClass") == "ADMITAD" || (results[i].get("contentClass") == "PARTNER" && results[i].get("landingPartner") == true)) {
                                items.push(results[i].toJSON());
                            }
                        }
					}

					var template = Handlebars.compile(tableTemplate);

					Handlebars.registerHelper("EAN", function (item) {
						return EAN;
					});
					
					Handlebars.registerHelper("urlParams", function (targetURL) {
						if (targetURL.indexOf(".admitad.") > -1 || targetURL.indexOf(".com/g/") > -1)
							return targetURL.concat("?subid=").concat(EAN);
						else 
							return targetURL;
					});

					var templateContent = template({
							items : items
//							,sm : sm
						});
					$("#partners").append(templateContent);
					
				},
				error : function (error) {
					dataLayer.push({"event":"alert_showed", "alert_message":"Error: " + error.code + " " + error.message});
				}
			});

		</script>
	</body>
</html>
					